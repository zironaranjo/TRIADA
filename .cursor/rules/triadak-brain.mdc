---
description: TRIADAK project brain - architecture, progress, and roadmap
alwaysApply: true
---

# TRIADAK - Project Brain

## What is Triadak?
SaaS platform for **vacation rental management** (triadak.io). Combines features inspired by **Bexio** (accounting), **VRPlatform** (trust accounting), and **Lodgify** (channel manager/PMS) into one unified platform.

## Tech Stack
- **Frontend**: React + Vite + TypeScript + Tailwind CSS + Framer Motion
- **Backend**: NestJS (currently minimal, most logic direct to Supabase)
- **Database/Auth/Storage**: Supabase (PostgreSQL + Auth + Storage + RLS)
- **Charts**: Recharts
- **Email**: Resend (via NestJS endpoint)
- **Deployment**: Docker + CI/CD (GitHub push triggers build)
- **Language**: Always respond in Spanish to the user

## Architecture
- Frontend connects **directly to Supabase** for most CRUD (properties, bookings, contacts, etc.)
- Backend NestJS used for email sending, webhooks, sync endpoints (Owners page still uses NestJS API via `ownersApi`)
- Row Level Security (RLS) enabled for multi-tenancy
- Supabase Storage bucket `property-images` with organized subfolders:
  - `avatars/{userId}/` — User profile avatars
  - `properties/` — Property images
  - `staff-avatars/{memberId}/` — Staff member avatars
  - `owner-avatars/{ownerId}/` — Owner avatars
- Notifications use `createPortal` to render outside sidebar (avoids overflow clipping)
- Supabase Realtime for live notification updates (requires `ALTER PUBLICATION supabase_realtime ADD TABLE notifications`)
- Reusable `useUserAvatar` hook for loading avatar across all pages

## Database Tables (Supabase - schema public)
- `bookings` - Reservations (guest_name, start_date, end_date, total_price, platform, status, property_id)
- `contact_notes` - Notes linked to contacts
- `contacts` - CRM contacts
- `expenses` - Operational expenses (category, amount, description, property_id, date)
- `ledger_entry` - Accounting entries (UNRESTRICTED RLS - needs review)
- `notifications` - In-app notifications (user_id, type, title, message, read, metadata) + DB trigger on booking insert
- `owner` - Property owners (firstName, lastName, email, phone, avatar_url) — camelCase columns (UNRESTRICTED RLS - needs review)
- `profiles` - User profiles (user_id, email, full_name, role)
- `properties` - Vacation rental properties (name, status, images, owner_id FK → owner.id, price_per_night, etc.)
- `settlements` - Owner settlement records (UNRESTRICTED RLS - needs review)
- `subscriptions` - User subscription plans
- `vendors` - Vendor/supplier records (UNRESTRICTED RLS - needs review)

**Note**: Tables marked UNRESTRICTED need RLS policies added for production security.
**Note**: `properties.owner_id` FK now points to `owner(id)` table (was changed from `profiles`).

## Completed Features
1. **Auth** - Supabase Auth with email verification, forgot password
2. **Properties CRUD** - Create, edit, delete properties with image upload to `properties/` subfolder in Supabase Storage
3. **Bookings CRUD** - Full booking management with list and calendar tab views
4. **Visual Calendar** - Integrated into Bookings page as tab (monthly view, mobile dots, stats)
5. **CRM/Contacts** - Contact management
6. **Owners** - Owner management (via NestJS API)
7. **Accounting/Ledger** - Basic ledger entries
8. **Dashboard Analytics** - Real data from Supabase: monthly revenue chart (AreaChart), platform distribution (PieChart), revenue by property (BarChart horizontal), occupancy progress bars, upcoming bookings list
9. **Landing Page** - Professional public page with real dashboard screenshot in hero, features, pricing, testimonials, FAQ, enlarged footer logo
10. **Mobile Responsive** - Full responsive layout with hamburger menu sidebar
11. **Onboarding** - Empty state guides for new users
12. **Email Confirmation** - Booking confirmation emails via Resend
13. **Multi-tenancy/RLS** - Row Level Security in Supabase
14. **Settings Page** - Profile (avatar upload, name, phone, company), Preferences (language, currency, timezone), Notifications (toggle switches), Danger Zone (password reset, delete account). Saves to Supabase (profile) + localStorage (preferences). Dark-only theme (no light/system toggle)
15. **Notification Center** - Bell icon in mobile header + desktop sidebar, portal-based dropdown panel with realtime updates, read/unread indicators, mark all read, clear all, delete individual, auto-notifications via DB trigger on booking insert
16. **Owner Statements** - Monthly settlement reports per owner: gross revenue, platform fees, agency commission, expenses, net payout. Expandable detail with bookings and expenses breakdown
17. **PDF/CSV Export** - Professional PDF reports (jspdf + jspdf-autotable) and CSV export for Owner Statements and Finance Dashboard
18. **User Avatar System** - Reusable `useUserAvatar` hook, avatar displayed in sidebar, mobile header, Owners page, and Owner Statements. Persists via localStorage + Supabase Storage fallback
19. **Owner Portal** - Separate `/owner/*` routes with dedicated layout (emerald theme), dashboard (revenue charts, occupancy, upcoming bookings), read-only properties view, and personal statements with PDF/CSV export. Owners with role `owner` are auto-redirected. Admins can access via sidebar link. Links owner record to user via email match (profiles.email = owner.email)
20. **Responsive Login** - Mobile-optimized login page with adaptive logo sizes, compact padding, and scroll support
21. **Developer Credit** - "Developed by zirox.io" in Login and Landing Page footers
22. **Role-Based Access System** - Three roles (admin/staff/owner) with auto-assignment:
    - First user = admin automatically
    - Email matching owner table = owner role
    - Default = staff
    - Login redirects owners to `/portal/dashboard`, admin/staff to `/dashboard`
    - Team management panel in Settings (admin only): view members, change roles, remove members
    - Owner portal at `/portal/*` uses separate OwnerLayout; admin accesses owner pages via `/owner/*` within main Layout
23. **Advanced Finance Engine** - Profit & Loss statement, expense reconciliation system (localStorage persisted), category filtering, reconciliation progress bar + status panel
24. **Scheduled Notifications System** - Supabase Edge Functions for automated check-in/check-out reminders (hourly cron) and daily digest (08:00 UTC cron). Configurable timing (6/12/24/48h) in Settings. SQL migration with notifications table schema
25. **Owner Detail System** - Click on owner opens modal with KPIs (properties, revenue, bookings, this month). "View Full Profile" navigates to `/owners/:id` with full page: header with edit, KPIs, tabs (Properties cards with per-property revenue, Statements link, Payment history). Working search filter on owners list
26. **Staff Operations (Enterprise)** - Full operational staff management at `/staff`:
    - Personnel tab: CRUD for cleaners/maintenance with name, email, phone, address, document ID, contract type (full-time/part-time/freelance), salary, assigned properties. Avatar upload via Supabase Storage
    - Tasks tab: task creation with type (cleaning/maintenance/inspection/laundry), property assignment, checklist items, date, cost. Status workflow (pending → in progress → completed → verified). Star rating system (1-5) for quality assessment
    - Payroll tab: summary table per employee with base salary + task costs = total. Grand total
    - Staff detail modal: click on card opens modal with avatar, KPIs (tasks/earned/rating), personal info, contract details, assigned properties, recent tasks
    - Auto-expense integration: completed tasks automatically create expenses in `expenses` table (appears in Finance Engine P&L)
    - SQL migration: `staff_members` (with avatar_url) and `staff_tasks` tables with RLS, triggers for updated_at
27. **Owner Avatar System** - Owner photos displayed in list, detail modal, and full profile page. Upload via hover on avatar in profile page and create modal. Stored in `property-images/owner-avatars/{id}/`

## Pending / Roadmap (Fase 2 & 3)

### Fase 2 - Funcionalidades clave ✅ COMPLETED
- [x] Multi-language support (i18n with react-i18next) — EN, DE, ES, FR implemented across all pages
- [x] Theme system removed — dark-only theme (light mode looked bad, reverted)
- [x] Owner portal (separate view at /owner/* with dashboard, properties, statements)
- [x] Accounting/Ledger improvements:
  - Category filter in Finance Dashboard header
  - Reconciliation system (mark expenses as reconciled/pending via checkbox, persisted in localStorage)
  - Progress bar showing reconciliation status
  - Full Profit & Loss statement (revenue by platform, expenses by category, fees, margins)
  - Reconciliation summary panel
- [x] Scheduled email notifications:
  - Edge Function `send-reminders` — scans bookings, generates check-in/check-out notifications for staff/admins
  - Edge Function `daily-digest` — morning summary of today's arrivals, departures, and tomorrow preview
  - Notification settings UI in Settings: configurable reminder timing (6h/12h/24h/48h), daily digest toggle
  - SQL migration for notifications table + cron job setup instructions
  - Supabase pg_cron integration (hourly reminders + daily digest at 08:00 UTC)

### Fase 3 - Integraciones externas
- [ ] Airbnb API integration (iCal sync first, then API if available)
- [ ] Booking.com API integration (iCal sync + XML API for availability)
- [ ] Lodgify integration (channel manager sync — centralized calendar)
- [ ] Stripe payment integration (deferred by user)

### Sugerencias adicionales (post Fase 3)
- [ ] **iCal Sync universal** — Importar/exportar calendarios iCal (.ics) por propiedad. Es la forma más rápida de sincronizar con Airbnb/Booking sin depender de APIs complejas. Bloquea fechas automáticamente entre plataformas
- [ ] **Dashboard de ocupación visual** — Calendario tipo Gantt por propiedad mostrando reservas, huecos libres y tasas de ocupación. Muy visual para presentaciones a clientes
- [ ] **Gestión de tareas/limpieza** — Sistema de tareas automáticas post-checkout (limpieza, lavandería, inspección). Asignar a miembros del staff con checklist y foto de verificación
- [ ] **Contratos y documentos** — Generación automática de contratos de alquiler en PDF con datos de la reserva. Firma digital integrada
- [ ] **Revenue Management / Dynamic Pricing** — Sugerencias de precios basadas en temporada, ocupación y demanda. Reglas de precios mínimos/máximos por propiedad
- [ ] **Guest App / Portal de huéspedes** — Portal público donde el huésped ve su reserva, instrucciones de check-in, WiFi, reglas de la casa, contacto de emergencia. Acceso por link único (sin registro)
- [ ] **Multi-currency support** — Soporte para propiedades en distintos países con conversión automática de divisas
- [ ] **Auditoría y logs** — Registro de todas las acciones (quién cambió qué, cuándo). Importante para empresas con varios empleados
- [ ] **Backup/Export de datos** — Exportar toda la data (propiedades, reservas, contactos, finanzas) en formato ZIP para cumplimiento legal y tranquilidad del cliente
- [ ] **WhatsApp/SMS integration** — Mensajes automáticos a huéspedes (confirmación, instrucciones check-in, agradecimiento post-checkout) via Twilio o WhatsApp Business API
- [ ] **KPI Benchmarking** — Comparar rendimiento entre propiedades: RevPAR, ADR, tasa de ocupación, tiempo medio de reserva. Ideal para presentar valor al propietario
- [ ] **Rol Operativo (future)** — Dar acceso limitado a cleaners/mantenimiento: ver tareas asignadas del día, marcar completadas, subir fotos de verificación, ver historial de pagos. No prioritario hasta post Fase 3

### Completed
- [x] Finance dashboard (improved with responsive layout, filters, export buttons)
- [x] Owner Statements (monthly settlement reports with PDF/CSV export)
- [x] Advanced reports (exportable PDF/CSV with jspdf)
- [x] Landing page polish (real dashboard screenshot, removed step numbers, footer logo enlarged)
- [x] Avatar in sidebar/header/Owners/Statements (useUserAvatar hook)
- [x] Property image upload fix (organized into properties/ folder, removed artificial timeout)
- [x] DB fix: properties.owner_id FK changed from profiles → owner table

## Key Files
- `frontend/src/App.tsx` - Main routing (public: /, /login; protected: /dashboard, /properties, /bookings, /owners, /crm, /accounting, /pricing, /billing, /settings, /statements)
- `frontend/src/components/Layout.tsx` - App shell with sidebar + mobile menu + NotificationCenter + user avatar
- `frontend/src/components/NotificationCenter.tsx` - Bell icon + portal dropdown with realtime notifications
- `frontend/src/hooks/useUserAvatar.ts` - Reusable hook to load user avatar (localStorage + Supabase Storage fallback)
- `frontend/src/pages/Dashboard.tsx` - Analytics dashboard with real Recharts graphs
- `frontend/src/pages/Bookings.tsx` - Bookings list + calendar tab view
- `frontend/src/pages/Properties.tsx` - Property CRUD + image upload to properties/ subfolder
- `frontend/src/pages/Settings.tsx` - User settings (profile, preferences, notifications, danger zone)
- `frontend/src/pages/LandingPage.tsx` - Public landing page with real dashboard screenshot
- `frontend/src/pages/Owners.tsx` - Owner management (uses NestJS API via ownersApi)
- `frontend/src/pages/OwnerStatements.tsx` - Monthly owner settlement reports (queries Supabase directly, table: `owner`)
- `frontend/src/components/OwnerLayout.tsx` - Owner portal shell with emerald-themed sidebar, avatar, back-to-admin link
- `frontend/src/pages/owner/OwnerDashboard.tsx` - Owner dashboard with revenue charts, occupancy, upcoming bookings
- `frontend/src/pages/owner/OwnerProperties.tsx` - Read-only property cards for owners
- `frontend/src/pages/owner/OwnerMyStatements.tsx` - Owner's personal monthly statements with PDF/CSV export
- `frontend/src/contexts/AuthContext.tsx` - Auth provider with profile, subscription, role management
- `frontend/src/api/client.ts` - Axios client for NestJS backend API (owners, properties, bookings)
- `frontend/src/lib/supabase.ts` - Supabase client config
- `frontend/src/lib/exportUtils.ts` - PDF/CSV export utilities (jspdf + jspdf-autotable)
- `frontend/src/pages/OwnerProfile.tsx` - Owner full profile page with tabs (properties, statements, payments)
- `frontend/src/pages/StaffOperations.tsx` - Staff operations management (personnel, tasks, payroll)
- `supabase/migrations/002_staff_operations.sql` - SQL setup for staff_members and staff_tasks tables
- `supabase/functions/send-reminders/index.ts` - Edge Function: hourly check-in/check-out reminder generator
- `supabase/functions/daily-digest/index.ts` - Edge Function: daily morning digest notification
- `supabase/migrations/001_notifications_table.sql` - SQL setup for notifications table, RLS, and cron jobs

## Conventions
- Use Supabase direct queries (not backend API) for frontend CRUD — except Owners which still uses NestJS API
- Tailwind for all styling, **dark-only** theme (bg-[#0f172a] base) — NO light mode
- Framer Motion for animations
- GlassCard component for card UI
- Mobile-first responsive: use `sm:`, `md:`, `lg:` breakpoints
- PowerShell terminal: do NOT chain commands with `&&`, use `;` instead
- Production build is strict TypeScript: remove ALL unused imports/variables (TS6133 errors break Docker build)
- Supabase Storage: use `property-images` bucket with subfolders (properties/, avatars/{userId}/)
- Owner table uses camelCase columns (firstName, lastName) — not snake_case

## Known Issues / Notes
- Docker build uses strict `tsc -b` which fails on unused imports (always clean up)
- Avatar upload uses `property-images` bucket with path `avatars/{userId}/avatar.{ext}`
- Property images upload to `properties/` subfolder (RLS policies needed for this path)
- Notification panel uses `createPortal(... , document.body)` to avoid sidebar overflow clipping
- Settings preferences (language, currency, etc.) saved to localStorage until i18n is fully implemented
- Supabase Realtime must be enabled via SQL: `ALTER PUBLICATION supabase_realtime ADD TABLE notifications`
- `owner` table is singular (not `owners`) — OwnerStatements queries it directly via Supabase
- `properties.owner_id` FK points to `owner(id)` — was changed from `profiles(id)`
