---
description: TRIADAK project brain - architecture, progress, and roadmap
alwaysApply: true
---

# TRIADAK - Project Brain

## What is Triadak?
SaaS platform for **vacation rental management** (triadak.io). Combines features inspired by **Bexio** (accounting), **VRPlatform** (trust accounting), and **Lodgify** (channel manager/PMS) into one unified platform.

## Tech Stack
- **Frontend**: React + Vite + TypeScript + Tailwind CSS + Framer Motion
- **Backend**: NestJS (currently minimal, most logic direct to Supabase)
- **Database/Auth/Storage**: Supabase (PostgreSQL + Auth + Storage + RLS)
- **Charts**: Recharts
- **Email**: Resend (via NestJS endpoint)
- **Deployment**: Docker + CI/CD (GitHub push triggers build)
- **Language**: Always respond in Spanish to the user

## Architecture
- Frontend connects **directly to Supabase** for most CRUD (properties, bookings, contacts, etc.)
- Backend NestJS used for email sending, webhooks, sync endpoints (Owners page still uses NestJS API via `ownersApi`)
- Row Level Security (RLS) enabled for multi-tenancy
- Supabase Storage bucket `property-images` with organized subfolders:
  - `avatars/{userId}/` — User profile avatars
  - `properties/` — Property images
- Notifications use `createPortal` to render outside sidebar (avoids overflow clipping)
- Supabase Realtime for live notification updates (requires `ALTER PUBLICATION supabase_realtime ADD TABLE notifications`)
- Reusable `useUserAvatar` hook for loading avatar across all pages

## Database Tables (Supabase - schema public)
- `bookings` - Reservations (guest_name, start_date, end_date, total_price, platform, status, property_id)
- `contact_notes` - Notes linked to contacts
- `contacts` - CRM contacts
- `expenses` - Operational expenses (category, amount, description, property_id, date)
- `ledger_entry` - Accounting entries (UNRESTRICTED RLS - needs review)
- `notifications` - In-app notifications (user_id, type, title, message, read, metadata) + DB trigger on booking insert
- `owner` - Property owners (firstName, lastName, email, phone) — camelCase columns (UNRESTRICTED RLS - needs review)
- `profiles` - User profiles (user_id, email, full_name, role)
- `properties` - Vacation rental properties (name, status, images, owner_id FK → owner.id, price_per_night, etc.)
- `settlements` - Owner settlement records (UNRESTRICTED RLS - needs review)
- `subscriptions` - User subscription plans
- `vendors` - Vendor/supplier records (UNRESTRICTED RLS - needs review)

**Note**: Tables marked UNRESTRICTED need RLS policies added for production security.
**Note**: `properties.owner_id` FK now points to `owner(id)` table (was changed from `profiles`).

## Completed Features
1. **Auth** - Supabase Auth with email verification, forgot password
2. **Properties CRUD** - Create, edit, delete properties with image upload to `properties/` subfolder in Supabase Storage
3. **Bookings CRUD** - Full booking management with list and calendar tab views
4. **Visual Calendar** - Integrated into Bookings page as tab (monthly view, mobile dots, stats)
5. **CRM/Contacts** - Contact management
6. **Owners** - Owner management (via NestJS API)
7. **Accounting/Ledger** - Basic ledger entries
8. **Dashboard Analytics** - Real data from Supabase: monthly revenue chart (AreaChart), platform distribution (PieChart), revenue by property (BarChart horizontal), occupancy progress bars, upcoming bookings list
9. **Landing Page** - Professional public page with real dashboard screenshot in hero, features, pricing, testimonials, FAQ, enlarged footer logo
10. **Mobile Responsive** - Full responsive layout with hamburger menu sidebar
11. **Onboarding** - Empty state guides for new users
12. **Email Confirmation** - Booking confirmation emails via Resend
13. **Multi-tenancy/RLS** - Row Level Security in Supabase
14. **Settings Page** - Profile (avatar upload, name, phone, company), Preferences (language, currency, timezone), Notifications (toggle switches), Danger Zone (password reset, delete account). Saves to Supabase (profile) + localStorage (preferences). Dark-only theme (no light/system toggle)
15. **Notification Center** - Bell icon in mobile header + desktop sidebar, portal-based dropdown panel with realtime updates, read/unread indicators, mark all read, clear all, delete individual, auto-notifications via DB trigger on booking insert
16. **Owner Statements** - Monthly settlement reports per owner: gross revenue, platform fees, agency commission, expenses, net payout. Expandable detail with bookings and expenses breakdown
17. **PDF/CSV Export** - Professional PDF reports (jspdf + jspdf-autotable) and CSV export for Owner Statements and Finance Dashboard
18. **User Avatar System** - Reusable `useUserAvatar` hook, avatar displayed in sidebar, mobile header, Owners page, and Owner Statements. Persists via localStorage + Supabase Storage fallback
19. **Owner Portal** - Separate `/owner/*` routes with dedicated layout (emerald theme), dashboard (revenue charts, occupancy, upcoming bookings), read-only properties view, and personal statements with PDF/CSV export. Owners with role `owner` are auto-redirected. Admins can access via sidebar link. Links owner record to user via email match (profiles.email = owner.email)
20. **Responsive Login** - Mobile-optimized login page with adaptive logo sizes, compact padding, and scroll support
21. **Developer Credit** - "Developed by zirox.io" in Login and Landing Page footers
22. **Role-Based Access System** - Three roles (admin/staff/owner) with auto-assignment:
    - First user = admin automatically
    - Email matching owner table = owner role
    - Default = staff
    - Login redirects owners to `/portal/dashboard`, admin/staff to `/dashboard`
    - Team management panel in Settings (admin only): view members, change roles, remove members
    - Owner portal at `/portal/*` uses separate OwnerLayout; admin accesses owner pages via `/owner/*` within main Layout

## Pending / Roadmap (Fase 2 & 3)

### Fase 2 - Funcionalidades clave
- [x] Multi-language support (i18n with react-i18next) — EN, DE, ES, FR implemented across all pages
- [x] Theme system removed — dark-only theme (light mode looked bad, reverted)
- [x] Owner portal (separate view at /owner/* with dashboard, properties, statements)
- [ ] Accounting/Ledger improvements (expense categorization, reconciliation, balance sheet — Bexio inspired)
- [ ] Scheduled email notifications (cron for check-in/out reminders — needs Edge Function)

### Fase 3 - Integraciones externas
- [ ] Airbnb API integration
- [ ] Booking.com API integration
- [ ] Lodgify integration (channel manager sync)
- [ ] Stripe payment integration (deferred by user)

### Completed
- [x] Finance dashboard (improved with responsive layout, filters, export buttons)
- [x] Owner Statements (monthly settlement reports with PDF/CSV export)
- [x] Advanced reports (exportable PDF/CSV with jspdf)
- [x] Landing page polish (real dashboard screenshot, removed step numbers, footer logo enlarged)
- [x] Avatar in sidebar/header/Owners/Statements (useUserAvatar hook)
- [x] Property image upload fix (organized into properties/ folder, removed artificial timeout)
- [x] DB fix: properties.owner_id FK changed from profiles → owner table

## Key Files
- `frontend/src/App.tsx` - Main routing (public: /, /login; protected: /dashboard, /properties, /bookings, /owners, /crm, /accounting, /pricing, /billing, /settings, /statements)
- `frontend/src/components/Layout.tsx` - App shell with sidebar + mobile menu + NotificationCenter + user avatar
- `frontend/src/components/NotificationCenter.tsx` - Bell icon + portal dropdown with realtime notifications
- `frontend/src/hooks/useUserAvatar.ts` - Reusable hook to load user avatar (localStorage + Supabase Storage fallback)
- `frontend/src/pages/Dashboard.tsx` - Analytics dashboard with real Recharts graphs
- `frontend/src/pages/Bookings.tsx` - Bookings list + calendar tab view
- `frontend/src/pages/Properties.tsx` - Property CRUD + image upload to properties/ subfolder
- `frontend/src/pages/Settings.tsx` - User settings (profile, preferences, notifications, danger zone)
- `frontend/src/pages/LandingPage.tsx` - Public landing page with real dashboard screenshot
- `frontend/src/pages/Owners.tsx` - Owner management (uses NestJS API via ownersApi)
- `frontend/src/pages/OwnerStatements.tsx` - Monthly owner settlement reports (queries Supabase directly, table: `owner`)
- `frontend/src/components/OwnerLayout.tsx` - Owner portal shell with emerald-themed sidebar, avatar, back-to-admin link
- `frontend/src/pages/owner/OwnerDashboard.tsx` - Owner dashboard with revenue charts, occupancy, upcoming bookings
- `frontend/src/pages/owner/OwnerProperties.tsx` - Read-only property cards for owners
- `frontend/src/pages/owner/OwnerMyStatements.tsx` - Owner's personal monthly statements with PDF/CSV export
- `frontend/src/contexts/AuthContext.tsx` - Auth provider with profile, subscription, role management
- `frontend/src/api/client.ts` - Axios client for NestJS backend API (owners, properties, bookings)
- `frontend/src/lib/supabase.ts` - Supabase client config
- `frontend/src/lib/exportUtils.ts` - PDF/CSV export utilities (jspdf + jspdf-autotable)

## Conventions
- Use Supabase direct queries (not backend API) for frontend CRUD — except Owners which still uses NestJS API
- Tailwind for all styling, **dark-only** theme (bg-[#0f172a] base) — NO light mode
- Framer Motion for animations
- GlassCard component for card UI
- Mobile-first responsive: use `sm:`, `md:`, `lg:` breakpoints
- PowerShell terminal: do NOT chain commands with `&&`, use `;` instead
- Production build is strict TypeScript: remove ALL unused imports/variables (TS6133 errors break Docker build)
- Supabase Storage: use `property-images` bucket with subfolders (properties/, avatars/{userId}/)
- Owner table uses camelCase columns (firstName, lastName) — not snake_case

## Known Issues / Notes
- Docker build uses strict `tsc -b` which fails on unused imports (always clean up)
- Avatar upload uses `property-images` bucket with path `avatars/{userId}/avatar.{ext}`
- Property images upload to `properties/` subfolder (RLS policies needed for this path)
- Notification panel uses `createPortal(... , document.body)` to avoid sidebar overflow clipping
- Settings preferences (language, currency, etc.) saved to localStorage until i18n is fully implemented
- Supabase Realtime must be enabled via SQL: `ALTER PUBLICATION supabase_realtime ADD TABLE notifications`
- `owner` table is singular (not `owners`) — OwnerStatements queries it directly via Supabase
- `properties.owner_id` FK points to `owner(id)` — was changed from `profiles(id)`
