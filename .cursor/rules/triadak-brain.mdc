---
description: TRIADAK project brain - architecture, progress, and roadmap
alwaysApply: true
---

# TRIADAK - Project Brain

## What is Triadak?
SaaS platform for **vacation rental management** (triadak.io). Combines features inspired by **Bexio** (accounting), **VRPlatform** (trust accounting), and **Lodgify** (channel manager/PMS) into one unified platform.

## Tech Stack
- **Frontend**: React + Vite + TypeScript + Tailwind CSS + Framer Motion
- **Backend**: NestJS (currently minimal, most logic direct to Supabase)
- **Database/Auth/Storage**: Supabase (PostgreSQL + Auth + Storage + RLS)
- **Charts**: Recharts
- **Email**: Resend (via NestJS endpoint)
- **Payments**: Stripe (Billing for subscriptions + Connect for guest payments)
- **Messaging**: Meta WhatsApp Cloud API (WhatsApp) + Twilio (SMS only)
- **Deployment**: Docker + Dokploy + CI/CD (GitHub push triggers build)
- **Production URLs**: Frontend `https://triadak.io` | Backend `https://api.triadak.io`
- **Language**: Always respond in Spanish to the user

## Architecture
- Frontend connects **directly to Supabase** for most CRUD (properties, bookings, contacts, etc.)
- Backend NestJS used for email sending, webhooks, sync endpoints (Owners page still uses NestJS API via `ownersApi`)
- Row Level Security (RLS) enabled for multi-tenancy
- Supabase Storage bucket `property-images` with organized subfolders:
  - `avatars/{userId}/` — User profile avatars
  - `properties/` — Property images
  - `staff-avatars/{memberId}/` — Staff member avatars
  - `owner-avatars/{ownerId}/` — Owner avatars
- Notifications use `createPortal` to render outside sidebar (avoids overflow clipping)
- Supabase Realtime for live notification updates (requires `ALTER PUBLICATION supabase_realtime ADD TABLE notifications`)
- Reusable `useUserAvatar` hook for loading avatar across all pages

## Database Tables (Supabase - schema public)
- `bookings` - Reservations (guest_name, start_date, end_date, total_price, platform, status, property_id, guest_token UUID for guest portal)
- `contact_notes` - Notes linked to contacts
- `contacts` - CRM contacts
- `expenses` - Operational expenses (category, amount, description, property_id, date)
- `ledger_entry` - Accounting entries (UNRESTRICTED RLS - needs review)
- `message_logs` - WhatsApp/SMS message history (booking_id, property_id, recipient_phone, channel, template_key, message, status, external_sid) with RLS
- `notifications` - In-app notifications (user_id, type, title, message, read, metadata) + DB trigger on booking insert
- `owner` - Property owners (firstName, lastName, email, phone, avatar_url) — camelCase columns (UNRESTRICTED RLS - needs review)
- `profiles` - User profiles (user_id, email, full_name, role)
- `properties` - Vacation rental properties (name, status, images, owner_id FK → owner.id, price_per_night, checkin_instructions, checkout_instructions, wifi_name, wifi_password, house_rules, emergency_contact, checkin_time, checkout_time, guest_portal_enabled, etc.)
- `settlements` - Owner settlement records (UNRESTRICTED RLS - needs review)
- `stripe_connect_accounts` - Stripe Express connected accounts (user_id, stripe_account_id, status, charges_enabled, payouts_enabled) with RLS
- `subscriptions` - User subscription plans (plan_id, status, interval, stripe_subscription_id, stripe_customer_id)
- `platform_connections` - Channel manager platform connections (property_id, platform, connection_type, ical_url, api_key, auto_sync_enabled, sync_interval_minutes, last_sync_at/status/message) with RLS
- `sync_logs` - Channel sync history logs (connection_id, property_id, platform, sync_type, status, added, updated, errors) with RLS
- `vendors` - Vendor/supplier records (UNRESTRICTED RLS - needs review)

**Note**: Tables marked UNRESTRICTED need RLS policies added for production security.
**Note**: `properties.owner_id` FK now points to `owner(id)` table (was changed from `profiles`).

## Completed Features
1. **Auth** - Supabase Auth with email verification, forgot password
2. **Properties CRUD** - Create, edit, delete properties with image upload to `properties/` subfolder in Supabase Storage
3. **Bookings CRUD** - Full booking management with list and calendar tab views
4. **Visual Calendar** - Integrated into Bookings page as tab (monthly view, mobile dots, stats)
5. **CRM/Contacts** - Contact management
6. **Owners** - Owner management (via NestJS API)
7. **Accounting/Ledger** - Basic ledger entries
8. **Dashboard Analytics** - Real data from Supabase: monthly revenue chart (AreaChart), platform distribution (PieChart), revenue by property (BarChart horizontal), occupancy progress bars, upcoming bookings list
9. **Landing Page** - Professional public page with real dashboard screenshot in hero, features, pricing, testimonials, FAQ, enlarged footer logo
10. **Mobile Responsive** - Full responsive layout with hamburger menu sidebar
11. **Onboarding** - Empty state guides for new users
12. **Email Confirmation** - Booking confirmation emails via Resend
13. **Multi-tenancy/RLS** - Row Level Security in Supabase
14. **Settings Page** - Profile (avatar upload, name, phone, company), Preferences (language, currency, timezone), Notifications (toggle switches), Danger Zone (password reset, delete account). Saves to Supabase (profile) + localStorage (preferences). Dark-only theme (no light/system toggle)
15. **Notification Center** - Bell icon in mobile header + desktop sidebar, portal-based dropdown panel with realtime updates, read/unread indicators, mark all read, clear all, delete individual, auto-notifications via DB trigger on booking insert
16. **Owner Statements** - Monthly settlement reports per owner: gross revenue, platform fees, agency commission, expenses, net payout. Expandable detail with bookings and expenses breakdown
17. **PDF/CSV Export** - Professional PDF reports (jspdf + jspdf-autotable) and CSV export for Owner Statements and Finance Dashboard
18. **User Avatar System** - Reusable `useUserAvatar` hook, avatar displayed in sidebar, mobile header, Owners page, and Owner Statements. Persists via localStorage + Supabase Storage fallback
19. **Owner Portal** - Separate `/owner/*` routes with dedicated layout (emerald theme), dashboard (revenue charts, occupancy, upcoming bookings), read-only properties view, and personal statements with PDF/CSV export. Owners with role `owner` are auto-redirected. Admins can access via sidebar link. Links owner record to user via email match (profiles.email = owner.email)
20. **Responsive Login** - Mobile-optimized login page with adaptive logo sizes, compact padding, and scroll support
21. **Developer Credit** - "Developed by zirox.io" in Login and Landing Page footers
22. **Role-Based Access System** - Three roles (admin/staff/owner) with auto-assignment:
    - First user = admin automatically
    - Email matching owner table = owner role
    - Default = staff
    - Login redirects owners to `/portal/dashboard`, admin/staff to `/dashboard`
    - Team management panel in Settings (admin only): view members, change roles, remove members
    - Owner portal at `/portal/*` uses separate OwnerLayout; admin accesses owner pages via `/owner/*` within main Layout
23. **Advanced Finance Engine** - Profit & Loss statement, expense reconciliation system (localStorage persisted), category filtering, reconciliation progress bar + status panel
24. **Scheduled Notifications System** - Supabase Edge Functions for automated check-in/check-out reminders (hourly cron) and daily digest (08:00 UTC cron). Configurable timing (6/12/24/48h) in Settings. SQL migration with notifications table schema
25. **Owner Detail System** - Click on owner opens modal with KPIs (properties, revenue, bookings, this month). "View Full Profile" navigates to `/owners/:id` with full page: header with edit, KPIs, tabs (Properties cards with per-property revenue, Statements link, Payment history). Working search filter on owners list
26. **Staff Operations (Enterprise)** - Full operational staff management at `/staff`:
    - Personnel tab: CRUD for cleaners/maintenance with name, email, phone, address, document ID, contract type (full-time/part-time/freelance), salary, assigned properties. Avatar upload via Supabase Storage
    - Tasks tab: task creation with type (cleaning/maintenance/inspection/laundry), property assignment, checklist items, date, cost. Status workflow (pending → in progress → completed → verified). Star rating system (1-5) for quality assessment
    - Payroll tab: summary table per employee with base salary + task costs = total. Grand total
    - Staff detail modal: click on card opens modal with avatar, KPIs (tasks/earned/rating), personal info, contract details, assigned properties, recent tasks
    - Auto-expense integration: completed tasks automatically create expenses in `expenses` table (appears in Finance Engine P&L)
    - SQL migration: `staff_members` (with avatar_url) and `staff_tasks` tables with RLS, triggers for updated_at
27. **Owner Avatar System** - Owner photos displayed in list, detail modal, and full profile page. Upload via hover on avatar in profile page and create modal. Stored in `property-images/owner-avatars/{id}/`
28. **iCal Sync Integration** - Bidirectional iCal calendar sync:
    - Import: Sync bookings from Airbnb/Booking.com via iCal URL per property. Auto-detects platform from URL. Deduplicates via `icalUid`. Status lowercase (`confirmed`). Per-event error handling
    - Export: `GET /bookings/ical/:propertyId` endpoint generates .ics feed for any property. Excludes cancelled bookings
    - Frontend: Sync button on property cards (only visible when iCal URL configured). Visual indicator (Link2 icon). Sync result toast (+added, updated). Copy export URL button. Direct link to .ics feed
    - Backend: `IcalService.syncPropertyCalendar()` + `IcalService.generateIcalExport()` in NestJS. Platform detection: Airbnb, Booking.com, VRBO, Other
    - i18n: All labels translated (EN, ES, DE, FR)
29. **Stripe Payments Integration** - Complete payment system with two flows:
    - **SaaS Subscriptions (Stripe Billing)**: `SubscriptionsModule` in NestJS with `POST /subscriptions/create-checkout` (Stripe Checkout in subscription mode), `POST /subscriptions/portal` (Stripe Customer Portal), `GET /subscriptions/verify-session` (verify after redirect), `GET /subscriptions/commission-rate`. Price IDs configurable via env vars. Webhook routing for subscription events (checkout.session.completed, subscription.updated/deleted, invoice.payment_failed)
    - **Guest Payments (Stripe Connect)**: `ConnectModule` in NestJS with `POST /connect/onboard` (Express account creation + onboarding link), `GET /connect/status` (account status from Stripe), `GET /connect/dashboard-link` (Express dashboard login). Entity `StripeConnectAccount` with TypeORM. SQL migration `003_stripe_connect.sql`
    - **Hybrid Commission Model**: Starter 0eur+8%, Basic 29eur+5%, Pro 79eur+3%, Enterprise 149eur+2%. Commission visible in Pricing.tsx and Billing.tsx. `application_fee_amount` applied to booking payments via Stripe Connect `transfer_data`
    - **Frontend**: Pricing.tsx calls `subscriptionsApi.createCheckout()` with fallback to Supabase trial. Billing.tsx shows commission rate, Stripe Customer Portal button, Stripe Connect onboarding/status section. `subscriptionsApi` and `connectApi` in client.ts
    - **i18n**: billing/pricing keys in EN, ES, DE, FR
30. **Channel Manager** - Centralized platform connection management at `/channels`:
    - **Platform support**: Airbnb (iCal), Booking.com (iCal), VRBO (iCal), Lodgify (REST API)
    - **Backend**: `ChannelsModule` with `ChannelsService` (connection CRUD, sync orchestration, Lodgify API, auto-sync scheduler, sync logs, stats). Entities: `PlatformConnection`, `SyncLog`. SQL migration `004_channel_manager.sql`
    - **Endpoints**: `GET/POST /channels/connections`, `PUT/DELETE /channels/connections/:id`, `POST /channels/connections/:id/sync`, `POST /channels/sync-all`, `GET /channels/sync-logs`, `GET /channels/stats`, `POST /channels/lodgify/test`
    - **Frontend**: KPI stats (connections, auto-sync, synced today, errors), platform cards with expand to see per-property status, connections table with search/filter, sync/enable/disable/delete actions, sync history panel, add connection modal (platform selection, property selector, iCal URL or API key, auto-sync toggle + interval)
    - **Lodgify**: Test API key, list properties, sync reservations via REST API
    - **Auto-sync**: Configurable intervals (15m/30m/1h/6h/12h/24h) per connection. `POST /channels/sync-all` checks all due connections
    - **i18n**: channels.* keys in EN, ES, DE, FR
31. **Occupancy Dashboard** - Visual Gantt-style calendar at `/occupancy`:
    - Date navigation (prev/next month, today button)
    - KPI cards: overall occupancy %, property count, booked nights, available nights, revenue
    - Platform legend with color-coded bars
    - Gantt chart with property rows, booking bars colored by platform
    - Per-property occupancy summary with percentage and booking count
    - Fetches bookings and properties from Supabase
    - **i18n**: occupancy.* keys in EN, ES, DE, FR
32. **Guest Portal** - Public-facing guest portal at `/guest/:token`:
    - **Backend**: `GET /bookings/guest/:token` endpoint returns booking + property details. `guest_token` (UUID) auto-generated on booking insert via SQL trigger
    - **Frontend**: Mobile-first portal displaying property name, address, dates, guest info, check-in/out instructions, WiFi (with show/hide password), house rules, emergency contact. No login required
    - **SQL migration**: `005_guest_portal.sql` adds `guest_token` to bookings + guest-facing columns to properties
    - **Bookings page**: Shows guest portal link with copy button for each booking
    - Properties can configure: `checkin_instructions`, `checkout_instructions`, `wifi_name`, `wifi_password`, `house_rules`, `emergency_contact`, `checkin_time`, `checkout_time`, `guest_portal_enabled`
33. **WhatsApp/SMS Messaging** - Messaging at `/messaging`:
    - **Backend**: `MessagingModule` with `MessagingService`. WhatsApp via **Meta WhatsApp Cloud API** (`graph.facebook.com/v22.0/{phone_number_id}/messages`). SMS via Twilio. Entity: `MessageLog`. SQL migration `006_messaging.sql`
    - **Endpoints**: `POST /messaging/send-template`, `POST /messaging/send-custom`, `POST /messaging/send-direct`, `GET /messaging/logs`, `GET /messaging/templates`, `GET /messaging/stats`, `GET /messaging/test-connection`
    - **6 message templates**: Booking confirmation, Check-in reminder, Check-in instructions (WiFi/rules), Check-out reminder, Guest portal link, Thank you post-checkout. Templates auto-populate booking/property data
    - **Meta templates**: Mapped in `metaTemplateMap` with named parameters (`parameter_name` field required by Meta Cloud API). Template names: `triadak_booking_confirm`, `triadak_checkin_reminder`, `triadak_stay_details`, `triadak_checkout_reminder`, `triadak_guest_portal`, `triadak_thank_you`
    - **Frontend**: KPI cards (total messages, WhatsApp, SMS, sent today), template quick-action cards, message history with expandable details (camelCase fields from TypeORM), send modal (template/custom/direct modes), channel selection, booking selector, connection status banner
    - **WhatsApp env vars**: `META_WHATSAPP_PHONE_ID` (Phone Number ID), `META_WHATSAPP_TOKEN` (access token — **expires periodically, needs renewal or permanent System User token**)
    - **SMS env vars**: `TWILIO_ACCOUNT_SID`, `TWILIO_AUTH_TOKEN`, `TWILIO_PHONE_NUMBER`
    - **i18n**: messaging.* keys in EN, ES, DE, FR
34. **Booking Edit Modal** - Edición inline de reservas en el modal de detalle:
    - Botón de editar (lápiz) en el header del modal de detalle de reserva
    - Formulario inline en el mismo modal: nombre huésped, email, teléfono, fechas, precio, plataforma, propiedad, notas
    - Botones Guardar/Cancelar. Actualiza en Supabase y recarga la lista
    - **i18n**: bookings.editBooking en EN, ES, DE, FR
35. **Contratos y Documentos** - Gestión de contratos de alquiler en `/contracts`:
    - Tabla de contratos con estado (draft/sent/signed/cancelled), filtros y búsqueda
    - Modal para generar contrato desde una reserva existente: rellena automáticamente nombre, fechas, propiedad, precio
    - Generación de PDF con jspdf (encabezado, cláusulas, datos de reserva, firma)
    - Link único de firma `/contract/:token` para el huésped (público, sin auth). Huésped escribe nombre como firma digital
    - Estados del contrato: draft → sent → signed. `signed_at` se registra en Supabase
    - Tabla `contracts` con RLS: usuario gestiona sus contratos, acceso público por `sign_token` para leer y firmar
    - SQL migration: `007_contracts.sql`
    - **i18n**: contracts.* keys en EN, ES, DE, FR
39. **Backup & Export de Datos** - Exportación completa en `/backup`:
    - Tarjeta principal: "Exportar ZIP Completo" — genera ZIP con CSV + JSON de cada sección + README.txt
    - 7 secciones individuales: propiedades, reservas, contactos, gastos, propietarios, contratos, personal
    - Cada sección muestra: icono, descripción, contador de registros, botones CSV y JSON independientes
    - Función `toCSV()` con escape correcto de comas, comillas y saltos de línea
    - Fecha del último backup guardada en `localStorage` key `triadak_last_backup`
    - Nota de privacidad: datos exportados directamente desde Supabase, sin servidores externos
    - Librería: `jszip` (instalada en frontend)
    - **i18n**: backup.* keys en EN, ES, DE, FR
38. **Auditoría y Logs** - Registro de actividad del equipo en `/audit`:
    - Timeline agrupado por día con badges de color por acción (creado=verde, actualizado=azul, eliminado=rojo, login=violeta, etc.)
    - Filtros: búsqueda por usuario/entidad, tipo de acción, tipo de entidad, rango de fechas
    - Cada entrada expandible muestra cambios campo a campo (antes/después en rojo/verde) o JSON completo
    - Exportar CSV con todos los registros filtrados
    - Paginación con "Cargar más" (50 por página)
    - Tabla `audit_logs` en Supabase con triggers automáticos en: bookings, properties, contacts, expenses
    - Utility `logAudit()` en `frontend/src/lib/auditLog.ts` para registrar acciones manuales desde frontend
    - SQL migration: `008_audit_logs.sql`
    - **i18n**: audit.* keys en EN, ES, DE, FR
37. **KPI Benchmarking** - Comparativa de rendimiento entre propiedades en `/benchmarking`:
    - Pódium visual (1º/2º/3º) con barras de altura proporcional y trofeo
    - Gráficos de barras horizontales switcheables: Ingresos, Ocupación %, ADR, RevPAR. Colores únicos por propiedad
    - Tabla de métricas detallada: posición, ingresos, reservas, ocupación (badge verde/amarillo/rojo), ADR, RevPAR, estancia media, vs media (±%)
    - Selector de período: este mes, mes anterior, últimos 3/6 meses, este año
    - Tarjetas de resumen: total propiedades, ingresos totales, total reservas, ocupación media
    - Exportar CSV con todas las métricas por propiedad
    - Todo calculado desde Supabase (sin backend)
    - **i18n**: benchmarking.* keys en EN, ES, DE, FR
36. **Revenue Management & Dynamic Pricing** - Optimización de precios en `/revenue`:
    - KPIs: RevPAR (ingreso por noche disponible), ADR (tarifa media diaria), % ocupación, ingreso potencial
    - Sugerencias de precio por propiedad: precio actual vs sugerido con botón "Aplicar" que actualiza `price_per_night` en Supabase
    - Algoritmo de precios: multiplicador de temporada + ajuste por ocupación (±15%) + prima fin de semana (+10%)
    - Reglas de temporada configurables: nombre, fechas MM-DD inicio/fin, multiplicador, tipo (alta/media/baja). Guardadas en `localStorage`
    - Calendario de precios mensual: colores por temporada, precio sugerido por día, días reservados marcados
    - Filtro por propiedad. Navegación por mes en el calendario
    - **i18n**: revenue.* keys en EN, ES, DE, FR

## Pending / Roadmap (Fase 2 & 3)

### Fase 2 - Funcionalidades clave ✅ COMPLETED
- [x] Multi-language support (i18n with react-i18next) — EN, DE, ES, FR implemented across all pages
- [x] Theme system removed — dark-only theme (light mode looked bad, reverted)
- [x] Owner portal (separate view at /owner/* with dashboard, properties, statements)
- [x] Accounting/Ledger improvements
- [x] Scheduled email notifications

### Fase 3 - Integraciones externas ✅ COMPLETED
- [x] iCal Sync — Import from Airbnb/Booking.com + Export .ics feed per property
- [x] Airbnb integration — iCal sync via Channel Manager (full API requires partner access)
- [x] Booking.com integration — iCal sync via Channel Manager (XML API requires partner access)
- [x] Lodgify integration — REST API sync via Channel Manager + iCal fallback
- [x] Stripe payment integration — SaaS subscriptions (Billing) + Guest payments (Connect) + Hybrid commission model
- [x] Channel Manager — Centralized platform connections, sync orchestration, auto-sync, sync logs

### Sugerencias adicionales (post Fase 3)
- [x] **iCal Sync universal** — Importar/exportar calendarios iCal (.ics) por propiedad. Sync + export implementado en Fase 3
- [x] **Dashboard de ocupación visual** — Calendario tipo Gantt por propiedad mostrando reservas, huecos libres y tasas de ocupación. Implementado en `/occupancy`
- [x] **Guest App / Portal de huéspedes** — Portal público con instrucciones de check-in, WiFi, reglas de la casa, contacto de emergencia. Acceso por link único. Implementado en `/guest/:token`
- [x] **WhatsApp/SMS integration** — Mensajes automáticos a huéspedes via Twilio (WhatsApp + SMS). 6 plantillas predefinidas + mensajes personalizados. Implementado en `/messaging`
- [ ] **Gestión de tareas/limpieza** — Sistema de tareas automáticas post-checkout (limpieza, lavandería, inspección). Asignar a miembros del staff con checklist y foto de verificación
- [x] **Contratos y documentos** — Generación automática de contratos PDF desde reservas. Firma digital simple: link único `/contract/:token` para que el huésped revise y firme. Estado: draft → sent → signed. Implementado en `/contracts`
- [x] **Revenue Management / Dynamic Pricing** — Página `/revenue` con KPIs (RevPAR, ADR, ocupación, ingreso potencial), sugerencias de precios por propiedad (basadas en reglas de temporada, ocupación y fin de semana), calendario de precios visual mensual. Reglas de temporada configurables (alta/media/baja + multiplicador) guardadas en localStorage. Botón "Aplicar" actualiza `price_per_night` en Supabase. 4 idiomas
- [x] **Multi-currency support** — `useCurrency` hook con 14 monedas (EUR base), tasas de cambio estáticas, `format()` aplicado en Revenue/Benchmarking. Settings ampliado con 14 opciones. `currency` column en `properties` (migration 009). Sin API externa
- [x] **Auditoría y logs** — Timeline por día con filtros, diff de cambios campo a campo, triggers automáticos en tablas clave, export CSV. Implementado en `/audit`
- [x] **Backup/Export de datos** — ZIP completo + exportación individual CSV/JSON por sección (7 tablas). Contador de registros, última fecha de backup en localStorage. Implementado en `/backup`
- [x] **KPI Benchmarking** — Pódium, gráficos comparativos (revenue/ocupación/ADR/RevPAR), tabla detallada con vs media, selector de período, export CSV. Implementado en `/benchmarking`
- [ ] **Rol Operativo (future)** — Dar acceso limitado a cleaners/mantenimiento: ver tareas asignadas del día, marcar completadas, subir fotos de verificación, ver historial de pagos

### Completed
- [x] Finance dashboard (improved with responsive layout, filters, export buttons)
- [x] Owner Statements (monthly settlement reports with PDF/CSV export)
- [x] Advanced reports (exportable PDF/CSV with jspdf)
- [x] Landing page polish (real dashboard screenshot, removed step numbers, footer logo enlarged)
- [x] Avatar in sidebar/header/Owners/Statements (useUserAvatar hook)
- [x] Property image upload fix (organized into properties/ folder, removed artificial timeout)
- [x] DB fix: properties.owner_id FK changed from profiles → owner table

## Key Files
- `frontend/src/App.tsx` - Main routing (public: /, /login, /guest/:token, /contract/:token; protected: /dashboard, /properties, /bookings, /owners, /crm, /accounting, /pricing, /billing, /settings, /statements, /channels, /occupancy, /messaging, /contracts, /revenue, /staff)
- `frontend/src/components/Layout.tsx` - App shell with sidebar + mobile menu + NotificationCenter + user avatar
- `frontend/src/components/NotificationCenter.tsx` - Bell icon + portal dropdown with realtime notifications
- `frontend/src/hooks/useUserAvatar.ts` - Reusable hook to load user avatar (localStorage + Supabase Storage fallback)
- `frontend/src/pages/Dashboard.tsx` - Analytics dashboard with real Recharts graphs
- `frontend/src/pages/Bookings.tsx` - Bookings list + calendar tab view
- `frontend/src/pages/Properties.tsx` - Property CRUD + image upload to properties/ subfolder
- `frontend/src/pages/Settings.tsx` - User settings (profile, preferences, notifications, danger zone)
- `frontend/src/pages/LandingPage.tsx` - Public landing page with real dashboard screenshot
- `frontend/src/pages/Owners.tsx` - Owner management (uses NestJS API via ownersApi)
- `frontend/src/pages/OwnerStatements.tsx` - Monthly owner settlement reports (queries Supabase directly, table: `owner`)
- `frontend/src/components/OwnerLayout.tsx` - Owner portal shell with emerald-themed sidebar, avatar, back-to-admin link
- `frontend/src/pages/owner/OwnerDashboard.tsx` - Owner dashboard with revenue charts, occupancy, upcoming bookings
- `frontend/src/pages/owner/OwnerProperties.tsx` - Read-only property cards for owners
- `frontend/src/pages/owner/OwnerMyStatements.tsx` - Owner's personal monthly statements with PDF/CSV export
- `frontend/src/contexts/AuthContext.tsx` - Auth provider with profile, subscription, role management
- `frontend/src/api/client.ts` - Axios client for NestJS backend API (owners, properties, bookings, subscriptions, connect, channels, messaging)
- `frontend/src/pages/ChannelManager.tsx` - Channel Manager page (platform connections, sync, auto-sync, logs)
- `frontend/src/pages/OccupancyDashboard.tsx` - Gantt-style occupancy calendar
- `frontend/src/pages/GuestPortal.tsx` - Public guest portal (no auth required)
- `frontend/src/pages/Messaging.tsx` - WhatsApp/SMS messaging page (templates, history, send modal)
- `frontend/src/pages/Pricing.tsx` - Plan selection with Stripe Checkout integration and commission rates
- `frontend/src/pages/Billing.tsx` - Subscription management, Stripe Customer Portal, Stripe Connect onboarding
- `frontend/src/lib/supabase.ts` - Supabase client config
- `frontend/src/lib/exportUtils.ts` - PDF/CSV export utilities (jspdf + jspdf-autotable)
- `frontend/src/pages/OwnerProfile.tsx` - Owner full profile page with tabs (properties, statements, payments)
- `frontend/src/pages/StaffOperations.tsx` - Staff operations management (personnel, tasks, payroll)
- `supabase/migrations/002_staff_operations.sql` - SQL setup for staff_members and staff_tasks tables
- `backend/src/bookings/ical.service.ts` - iCal sync (import from URL) + export (.ics generation) service
- `backend/src/bookings/bookings.controller.ts` - Bookings API endpoints including sync + iCal export
- `backend/src/subscriptions/subscriptions.service.ts` - Stripe Billing: checkout sessions, customer portal, webhook handling
- `backend/src/subscriptions/subscriptions.controller.ts` - Subscription endpoints (create-checkout, portal, verify-session, commission-rate)
- `backend/src/connect/connect.service.ts` - Stripe Connect: Express accounts, onboarding, status, dashboard links, fee calculation
- `backend/src/connect/connect.controller.ts` - Connect endpoints (onboard, status, dashboard-link)
- `backend/src/payments/payments.service.ts` - Booking payments with Connect support (application_fee + transfer_data)
- `supabase/functions/send-reminders/index.ts` - Edge Function: hourly check-in/check-out reminder generator
- `supabase/functions/daily-digest/index.ts` - Edge Function: daily morning digest notification
- `backend/src/channels/channels.service.ts` - Channel Manager: connection CRUD, iCal/API sync, Lodgify integration, auto-sync
- `backend/src/channels/channels.controller.ts` - Channel Manager REST endpoints
- `backend/src/messaging/messaging.service.ts` - Meta WhatsApp Cloud API + Twilio SMS service (send, named-param templates, logs, stats)
- `frontend/src/pages/Contracts.tsx` - Contracts page (list, generate PDF from booking, copy sign link, preview, download)
- `frontend/src/pages/ContractSign.tsx` - Public guest signing page at /contract/:token (no auth required)
- `frontend/src/pages/RevenueManagement.tsx` - Revenue & Pricing page at /revenue (RevPAR/ADR KPIs, price suggestions per property, season rules localStorage, price calendar)
- `frontend/src/pages/Benchmarking.tsx` - KPI Benchmarking page at /benchmarking (podium, switchable bar charts, detailed metrics table, period selector, CSV export)
- `frontend/src/pages/AuditLog.tsx` - Audit log page at /audit (timeline by day, action badges, diff viewer, filters, CSV export, load more)
- `frontend/src/pages/DataBackup.tsx` - Data backup page at /backup (full ZIP export, per-section CSV/JSON, record counts, jszip)
- `frontend/src/hooks/useCurrency.ts` - Multi-currency hook: 14 currencies, EUR-based static rates, format()/convert()/convertFrom(), reads preferred currency from localStorage
- `supabase/migrations/009_property_currency.sql` - Adds currency column to properties table (default EUR)
- `frontend/src/lib/auditLog.ts` - logAudit() utility for manual audit logging from frontend
- `supabase/migrations/008_audit_logs.sql` - SQL setup for audit_logs table + triggers on bookings/properties/contacts/expenses
- `supabase/migrations/007_contracts.sql` - SQL setup for contracts table with RLS
- `backend/src/messaging/messaging.controller.ts` - Messaging REST endpoints
- `supabase/migrations/001_notifications_table.sql` - SQL setup for notifications table, RLS, and cron jobs
- `supabase/migrations/004_channel_manager.sql` - SQL setup for platform_connections and sync_logs tables
- `supabase/migrations/005_guest_portal.sql` - SQL setup for guest_token on bookings + guest-facing columns on properties
- `supabase/migrations/006_messaging.sql` - SQL setup for message_logs table

## Conventions
- Use Supabase direct queries (not backend API) for frontend CRUD — except Owners which still uses NestJS API
- Tailwind for all styling, **dark-only** theme (bg-[#0f172a] base) — NO light mode
- Framer Motion for animations
- GlassCard component for card UI
- Mobile-first responsive: use `sm:`, `md:`, `lg:` breakpoints
- PowerShell terminal: do NOT chain commands with `&&`, use `;` instead
- Production build is strict TypeScript: remove ALL unused imports/variables (TS6133 errors break Docker build)
- Supabase Storage: use `property-images` bucket with subfolders (properties/, avatars/{userId}/)
- Owner table uses camelCase columns (firstName, lastName) — not snake_case

## Known Issues / Notes
- Docker build uses strict `tsc -b` which fails on unused imports (always clean up)
- Avatar upload uses `property-images` bucket with path `avatars/{userId}/avatar.{ext}`
- Property images upload to `properties/` subfolder (RLS policies needed for this path)
- Notification panel uses `createPortal(... , document.body)` to avoid sidebar overflow clipping
- Settings preferences (language, currency, etc.) saved to localStorage until i18n is fully implemented
- Supabase Realtime must be enabled via SQL: `ALTER PUBLICATION supabase_realtime ADD TABLE notifications`
- `owner` table is singular (not `owners`) — OwnerStatements queries it directly via Supabase
- `properties.owner_id` FK points to `owner(id)` — was changed from `profiles(id)`
- No staging environment — working directly on main/production (triadak.io)
- Stripe configured in test mode (`sk_test_...`) — switch to `sk_live_...` for production payments
- Stripe webhook endpoint: `https://api.triadak.io/webhooks/stripe`
- SQL migration `003_stripe_connect.sql` already executed in Supabase
- SQL migration `004_channel_manager.sql` already executed in Supabase
- SQL migration `005_guest_portal.sql` already executed in Supabase
- SQL migration `006_messaging.sql` already executed in Supabase
- SQL migration `007_contracts.sql` already executed in Supabase
- Revenue Management rules saved in `localStorage` key `triadak_season_rules` (no DB table needed)
- Benchmarking page calculates all KPIs client-side from Supabase `properties` + `bookings` (no backend needed)
- **PENDING**: SQL migration `008_audit_logs.sql` must be executed in Supabase SQL Editor before audit logs work
- **PENDING**: SQL migration `009_property_currency.sql` must be executed in Supabase SQL Editor
- `useCurrency` hook reads from `localStorage` key `triadak_preferences` → `currency` field (set in Settings > Preferences). Default: EUR. 14 currencies with static EUR-based rates (Feb 2026)
- `audit_logs` triggers use `auth.uid()` and JWT claims to capture the acting user. `SECURITY DEFINER` needed for trigger function
- Airbnb/Booking.com full APIs require partner access — iCal sync available now, API ready when approved
- **Meta WhatsApp Cloud API** ya configurada y funcionando. Número: `+34 643 26 77 97`. Phone ID: `942271912297397`. Env vars: `META_WHATSAPP_PHONE_ID`, `META_WHATSAPP_TOKEN`
- **IMPORTANTE**: El `META_WHATSAPP_TOKEN` es un token temporal que caduca (~1h en desarrollo). Para producción estable hay que crear un **System User token permanente** en Meta Business Manager → Configuración → Usuarios del sistema → Generar token sin fecha de expiración con permisos `whatsapp_business_messaging` + `whatsapp_business_management`
- Twilio configurado para SMS únicamente. Env vars: `TWILIO_ACCOUNT_SID`, `TWILIO_AUTH_TOKEN`, `TWILIO_PHONE_NUMBER`
- `bookings` tabla: columna renombrada de `icalUid` (camelCase) a `ical_uid` (snake_case) para coincidir con la entidad TypeORM. Ejecutado en Supabase SQL Editor: `ALTER TABLE bookings RENAME COLUMN "icalUid" TO ical_uid`
- `Messaging.tsx` usa campos camelCase (`recipientName`, `recipientPhone`, `templateKey`, `externalSid`, `errorMessage`, `createdAt`) para coincidir con la respuesta TypeORM del backend
- Las plantillas Meta usan variables con nombre (`{{guest_name}}`, `{{property_name}}`, etc.) — el backend envía `parameter_name` en cada parámetro tal como requiere Meta Cloud API v22.0
- **PENDING**: Crear token permanente de System User en Meta Business Manager para evitar renovación manual del token
